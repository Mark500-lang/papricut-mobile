workflows:
  ios-distribute:
    name: iOS Distribute Workflow
    environment:
      vars:
        XCODE_PROJECT: "ios/App.xcodeproj"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "papricut.app.mobile"
        APP_STORE_CONNECT_USERNAME: $APP_STORE_CONNECT_USERNAME
      groups:
        - Papricut
    triggering:
      events:
        - push
    scripts:
      - name: Pre-clean Xcode caches and keychain
        script: |
          set -e
          echo "üßπ Cleaning Xcode DerivedData, keychains, and provisioning profiles..."
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*
          security delete-keychain build.keychain || true

      - name: Set up keychain and code signing
        script: |
          set -e
          echo "üîê Setting up certificate and provisioning profile..."

          if [ -z "$DISTRIBUTION_CERTIFICATE" ] || [ -z "$CERTIFICATE_PASSWORD" ] || [ -z "$PROVISIONING_PROFILE" ]; then
            echo "‚ùå Missing required signing credentials"
            exit 1
          fi

          echo "$DISTRIBUTION_CERTIFICATE" | base64 --decode > certificate.p12
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          echo "üì• Importing .p12..."
          if ! security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign; then
            echo "‚ùå Failed to import certificate. Check that the password is correct and the .p12 is valid"
            exit 1
          fi

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Install dependencies
        script: |
          set -e
          echo "üì¶ Installing dependencies..."
          npm install -g @ionic/cli
          npm ci

      - name: Build Ionic project
        script: |
          set -e
          echo "‚öôÔ∏è Building Ionic project..."
          ionic build --prod || { echo "‚ùå Ionic build failed"; exit 1; }
          npx cap sync ios || { echo "‚ùå Capacitor sync failed"; exit 1; }

      - name: Build .ipa with xcodebuild
        script: |
          set -e
          echo "üì± Archiving project with xcodebuild..."
          xcodebuild -workspace ios/App.xcworkspace \
                     -scheme "$XCODE_SCHEME" \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath $HOME/build/App.xcarchive \
                     archive || { echo "‚ùå xcodebuild archive failed"; exit 1; }

          echo "üì¶ Exporting .ipa..."
          xcodebuild -exportArchive \
                     -archivePath $HOME/build/App.xcarchive \
                     -exportOptionsPlist ExportOptions.plist \
                     -exportPath $HOME/build/ipa || { echo "‚ùå xcodebuild export failed"; exit 1; }

      - name: Upload to App Store
        script: |
          set -e
          echo "üöÄ Uploading to App Store..."

          IPA_PATH=$(find $HOME/build/ipa -name "*.ipa" | head -n 1)
          if [ ! -f "$IPA_PATH" ]; then
            echo "‚ùå .ipa file not found. Upload aborted."
            exit 1
          fi

          if [ -z "$APP_STORE_CONNECT_USERNAME" ] || [ -z "$APP_SPECIFIC_PASSWORD" ]; then
            echo "‚ùå Missing App Store Connect credentials"
            exit 1
          fi

          xcrun altool --upload-app -f "$IPA_PATH" \
                       -t ios \
                       -u "$APP_STORE_CONNECT_USERNAME" \
                       -p "$APP_SPECIFIC_PASSWORD" || {
            echo "‚ùå Upload to App Store failed"
            exit 1
          }

    artifacts:
      - build/ipa/*.ipa
